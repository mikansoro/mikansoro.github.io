<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><meta content="<p>I finally switched from sealed-secrets to sops + age for managing Kubernetes secrets in git. It's been a long time coming.</p>
" name=description><title>Kubernetes Secrets - from Sealed-Secrets to Sops+Age</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#ff7f27;--primary-pale-color:#ff7f2710;--text-color:#3c4043;--text-pale-color:#929ab0;--bg-color:#eee;--highlight-mark-color:#5f75b045;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460;--main-font:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:70px;--paragraph-font-size:16px;--paragraph-line-height:1.75;--aside-font-size:15px;--img-border-radius:0;--inline-code-border-radius:2px}body.dark{--primary-color:#ff7f27;--primary-pale-color:#ff7f2720;--text-color:#9197a5;--text-pale-color:#626975;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><body class=post><script>if(sessionStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>mikansoro</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/blog/>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/about/>about</a><span class="wrap-separator fold">,</span><a class=fold href=/blogroll/>blogroll</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/blog//feed.xml><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#sealed-secrets-and-why-i-left-them-behind>Sealed-Secrets, and Why I Left them Behind</a><li><a class=h2 href=#back-to-basics-sops-age>Back to Basics: sops + age</a> <ul><li><a class=h3 href=#kubernetes-with-ksops>Kubernetes with ksops</a></ul><li><a class=h2 href=#lets-encrypt-some-secrets>Lets Encrypt some Secrets</a> <ul><li><a class=h3 href=#setting-up-sops-age-on-nixos>Setting up sops + age on NixOS</a><li><a class=h3 href=#generating-age-keys>Generating Age Keys</a><li><a class=h3 href=#configuring-sops>Configuring Sops</a><li><a class=h3 href=#encrypting-a-kubernetes-secret>Encrypting a Kubernetes Secret</a></ul><li><a class=h2 href=#deploying-encrypted-secrets-with-argocd>Deploying Encrypted Secrets with ArgoCD</a> <ul><li><a class=h3 href=#telling-kustomize-about-our-secrets>Telling Kustomize about our Secrets</a><li><a class=h3 href=#i-thought-this-was-about-argocd>I thought this was about ArgoCD...</a></ul></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Kubernetes Secrets - from Sealed-Secrets to Sops+Age</h1><div id=post-info><div id=date><span id=publish>2025-12-24</span></div><div id=tags><a href=https://mikansoro.org/tags/kubernetes><span>#</span>kubernetes</a><a href=https://mikansoro.org/tags/secrets><span>#</span>secrets</a></div></div><span id=continue-reading></span><p>Right after spinning up my first (and recently retired) Kubernetes cluster, one of the first problems I faced was how to manage secrets for the applications I wanted to run on it. If I had chosen to deploy my cluster with a cloud provider, the simple and obvious choice would be to use whatever secrets management platform they had on offer. I was not afforded that luxury with selfhosting. Likewise I could've created secrets imperatively with <code>kubectl create secret</code> and called it a day. That felt even dirtier than signing up for AWS just to use Secrets Manager. I was going to do it the "right" way: Kubernetes, with blackjack and gitops!<p>There were a few ways I could solve this thorny problem, including <a rel="nofollow noreferrer" href=https://github.com/bitnami-labs/sealed-secrets>sealed-secrets</a>, <a rel="nofollow noreferrer" href=https://github.com/getsops/sops>sops</a>, and <a rel="nofollow noreferrer" href=https://www.hashicorp.com/products/vault>Hashicorp Vault</a>. Vault was so far beyond overkill I couldn't see it over the horizon, and running it to manage a couple of api keys was out of the question. At the time, 1password didn't support api access to secrets in Kubernetes on any sort of plan obtainable by a puny individual subscriber, so integrating directly with my password manager was also out of the question.<p>Sops, originally created by Mozilla, seemed like a good solution. Pass it a GPG key (or several other formats) and it could encrypt portions of files at rest, making them safe to commit to a git repository. It felt like ansible-vault, but capable of standalone operation. For reasons unknown to me at the time of writing, I decided it was too much headache to manage keys and partial repo encryption, and went looking elsewhere.<p>Eventually, I landed on the sealed-secrets controller developed by bitnami. It ran a controller inside Kubernetes that generated a key on first boot, and kubernetes secrets were encrypted via a cli tool to store at rest in git. The key was (in theory) unextractable, tying an encrypted secret manifest to a cluster. Even better, sealed-secrets included a CRD for the encrypted secret resource which made secret management with ArgoCD a breeze.<h1 id=sealed-secrets-and-why-i-left-them-behind>Sealed-Secrets, and Why I Left them Behind<a aria-label="Anchor link for: sealed-secrets-and-why-i-left-them-behind" class=zola-anchor href=#sealed-secrets-and-why-i-left-them-behind style=visibility:hidden>#</a></h1><p>When I only had a single cluster, life was easy. Deploying the controller was a breeze. I created manifests, stored them in git, and wrote a short helper script to manage secret encryption with sealed-secrets. I went on with my day deploying workloads to my shiny new Kubernetes cluster.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">!/usr/bin/env bash</span><span class="z-comment z-line z-number-sign z-shell">
</span>
<span class="z-keyword z-control z-conditional z-if z-shell">if</span> <span class="z-support z-function z-test z-begin z-shell">[</span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-logical z-shell">!</span> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>f</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-support z-function z-test z-end z-shell">]</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-conditional z-then z-shell">then</span>
    <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>Requires path to a secret file to seal.<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">>&</span><span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">2</span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-exit z-shell">exit</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1</span>
<span class="z-keyword z-control z-conditional z-end z-shell">fi</span>

<span class="z-keyword z-control z-conditional z-if z-shell">if</span> <span class="z-support z-function z-test z-begin z-shell">[</span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yq</span></span><span class="z-meta z-function-call z-arguments z-shell"> e <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>.kind<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-keyword z-operator z-logical z-shell">!=</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>Secret<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-support z-function z-test z-end z-shell">]</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-conditional z-then z-shell">then</span>
    <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>File <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span> must be a secret manifest<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">>&</span><span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">2</span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-exit z-shell">exit</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1</span>
<span class="z-keyword z-control z-conditional z-end z-shell">fi</span>

<span class="z-variable z-other z-readwrite z-assignment z-shell">tmpl_file</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">tmpl_dir</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dirname</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">tmpl_filename</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">basename</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">tmp_file</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">tmpl_dir</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span>/<span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmpl_filename</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cut</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>.<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f1</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span>.tmp.yaml<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">sealed_file</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">tmpl_dir</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span>/<span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmpl_filename</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cut</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>.<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f1</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span>.sealed.yaml<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> regular expression to check for any base64 encoded values in input file</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> if a base64 value is found, assume secret is properly formatted.</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> runs with grep -Po, to force perl mode regular expression evaluation for positive lookback support to avoid matching other k8s keys/values</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> positive lookback: '(?<=\: )' -> only match if ': ' exists before the base64 text</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-keyword z-control z-conditional z-if z-shell">if</span> <span class="z-keyword z-operator z-logical z-shell">!</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Po</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>(?<=\: )([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)?$<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-conditional z-then z-shell">then</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yq</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>json <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">jq</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>.data |= map_values(@base64) | { data: .data }<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yq</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>P</span> eval-all <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>. as $item ireduce ({}; . * $item )<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmpl_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> - <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmp_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
<span class="z-keyword z-control z-conditional z-else z-shell">else</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmpl_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmp_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
<span class="z-keyword z-control z-conditional z-end z-shell">fi</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kubeseal</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>controller-namespace</span> sealed-secrets <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmp_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">sealed_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-keyword z-operator z-logical z-or z-shell">||</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rm</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">sealed_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rm</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">tmp_file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span></code></pre><p>Two years in, I needed to deploy my first workload that needed to be open to the public internet: Nextcloud. Not wanting to open the internet floodgate to my hand-rolled, no automation kubeadm managed house of jank that was my first attempt at Kubernetes, I decided it best to separate fully public workloads from private ones with a dedicated cluster in a separate, isolated network with minimal permissions. Great idea, right?<p>It was. Except for a neat little conundrum I unwittingly committed future me to solving. My manifests for core cluster components like <a rel="nofollow noreferrer" href=https://cert-manager.io/>cert-manager</a> weren't completely portable. The sealed-secrets controller's decryption key couldn't be replicated to the new cluster (without work and <em>a lot of</em> jank), so the easiest path forward was to pull secrets off the private cluster one-by-one and re-encrypt them for the new cluster. (Yes, I could've made new API keys for some of these services, I have now. Not the point here.)<p>Now, what happens when my third (or fourth) cluster come along? The problem continues to compound. Add on the fact that secrets can't be decrypted locally for inspection and rotating secrets requires accessing every cluster to re-encrypt the template? The friction is unsustainable.<h1 id=back-to-basics-sops-age>Back to Basics: sops + age<a aria-label="Anchor link for: back-to-basics-sops-age" class=zola-anchor href=#back-to-basics-sops-age style=visibility:hidden>#</a></h1><p>Ironically, I'm looking to the same solution I dismissed early on as "too complex" for salvation. "Too complex" isn't quite right; my past self describing sops as "too difficult" would be more accurate. It was reasonable at the time to pick a tooling ecosystem with a low barrier to entry for which I already had a strong mental model, but now it's time to pick something <a rel="nofollow noreferrer" href=https://scotmcknight.substack.com/p/difference-between-easy-and-simple><em>simple</em></a>.<p>Sops on its own won't offer me salvation, but it gets me close. Sops handles encryption and decryption of yaml files on disk (including partial encryption by encrypting only the <em>actually sensitive</em> keys, which is awesome!), but on its own it neither knows or cares about Kubernetes. It needs some help.<p>Sops also has support for a few different types of encryption keys, but I'll be using <a rel="nofollow noreferrer" href=https://github.com/FiloSottile/age>age</a> as it's a well-tested modern encryption solution that integrates cleanly with sops. With the incredible <a rel="nofollow noreferrer" href=https://github.com/Mic92/ssh-to-age/>ssh-to-age</a> I can even use machine-specific ssh keys to encrypt and decrypt secret data! No sharing keys across every development device!<h2 id=kubernetes-with-ksops>Kubernetes with ksops<a aria-label="Anchor link for: kubernetes-with-ksops" class=zola-anchor href=#kubernetes-with-ksops style=visibility:hidden>#</a></h2><p>My main concern with switching to sops was integrating my encrypted secrets data with my deployment tools of choice: kustomize and ArgoCD. Luckily, the folks over at Viaduct AI created <a rel="nofollow noreferrer" href=https://github.com/viaduct-ai/kustomize-sops>kustomize-sops</a> (<code>ksops</code>), a kustomize plugin written in go that can handle the decryption of sops secrets during a <code>kustomize build</code> execution. They even included a handy guide for integrating their plugin into ArgoCD via an initContainer.<p>I won't cover integrations with other tools like Helm here. I already make heavy use of Kustomize in my repository for patches and management of remote manifests from upstream projects. I haven't been publicly vocal about my distaste for Helm before, but at best Helm is a mistake. I won't turn this into a rant, it deserves its own post. Stay tuned for that.<p>Tangent aside, let's move on to the fun stuff.<h1 id=lets-encrypt-some-secrets>Lets Encrypt some Secrets<a aria-label="Anchor link for: lets-encrypt-some-secrets" class=zola-anchor href=#lets-encrypt-some-secrets style=visibility:hidden>#</a></h1><p>Any type of secret, not just TLS certs (i'm sorry, the pun was too good to omit).<p>Let's look at a practical deployment of sops + age, integrated with ArgoCD.<h2 id=setting-up-sops-age-on-nixos>Setting up sops + age on NixOS<a aria-label="Anchor link for: setting-up-sops-age-on-nixos" class=zola-anchor href=#setting-up-sops-age-on-nixos style=visibility:hidden>#</a></h2><p>I'll walk through how I use sops with Kubernetes, but you don't need to copy my implementation to implement this yourself.<p>All of my workstations (and soon, all of my servers!) run on NixOS. The "everything is declarative" approach to package management and configuration is <em>amazing</em> for reproducing environments across multiple machines. That extends to nix-shell too, a method of defining a "devshell" specific to a project. I have the following <code>shell.nix</code> file in my Kubernetes manifests/argocd git repo:<pre class="language-nix z-code" data-lang=nix><code class=language-nix data-lang=nix><span class="z-source z-nix"><span class="z-punctuation z-definition z-entity z-function z-2 z-nix">{</span> <span class="z-variable z-parameter z-function z-1 z-nix">pkgs</span> <span class="z-keyword z-operator z-nix">?</span> <span class="z-support z-function z-nix">import</span> <span class="z-string z-unquoted z-spath z-nix">&LTnixpkgs></span> <span class="z-punctuation z-definition z-attrset z-nix">{</span><span class="z-punctuation z-definition z-attrset z-nix">}</span> <span class="z-punctuation z-definition z-entity z-function z-nix">}</span><span class="z-punctuation z-definition z-function z-nix">:</span>

<span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>;

<span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">mkShellNoCC</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
  <span class="z-entity z-other z-attribute-name z-multipart z-nix">buildInputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span>
    <span class="z-comment z-line z-number-sign z-nix"># sops tooling</span>
    <span class="z-variable z-parameter z-name z-nix">sops</span>
    <span class="z-variable z-parameter z-name z-nix">age</span>
    <span class="z-variable z-parameter z-name z-nix">ssh-to-age</span>
    <span class="z-variable z-parameter z-name z-nix">kustomize-sops</span>
    <span class="z-variable z-parameter z-name z-nix">kustomize</span>
  <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>

  <span class="z-comment z-line z-number-sign z-nix"># thanks github:starcraft66/infrastructure</span>
  <span class="z-entity z-other z-attribute-name z-multipart z-nix">KUSTOMIZE_PLUGIN_HOME</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">buildEnv</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
    <span class="z-entity z-other z-attribute-name z-multipart z-nix">name</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>kustomize-plugins<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
    <span class="z-entity z-other z-attribute-name z-multipart z-nix">paths</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>; <span class="z-punctuation z-definition z-list z-nix">[</span>
      <span class="z-variable z-parameter z-name z-nix">kustomize-sops</span>
    <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
    <span class="z-entity z-other z-attribute-name z-multipart z-nix">postBuild</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-other z-nix"><span class="z-punctuation z-definition z-string z-other z-start z-nix">''</span>
      mv $out/lib/* $out
      rm -r $out/lib
    <span class="z-punctuation z-definition z-string z-other z-end z-nix">''</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
    <span class="z-entity z-other z-attribute-name z-multipart z-nix">pathsToLink</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>/lib<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>

  <span class="z-entity z-other z-attribute-name z-multipart z-nix">shellHook</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-other z-nix"><span class="z-punctuation z-definition z-string z-other z-start z-nix">''</span>
     export SOPS_AGE_KEY="$(ssh-to-age -private-key -i $HOME/.ssh/id_ed25519)"
  <span class="z-punctuation z-definition z-string z-other z-end z-nix">''</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
<span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></code></pre><p>This does a few things, and credit to github user <a rel="nofollow noreferrer" href=https://github.com/starcraft66/infrastructure/blob/89caa0506ce7c21a7b11cb39c5b304ee69652b82/flake.nix#L80-L90>starcraft66's infrastructure repo</a> for the <code>KUSTOMIZE_PLUGIN_HOME</code> variable creation example. This nix shell sets up the following:<ul><li>installs necessary packages (<code>sops</code>, <code>age</code>, <code>kustomize</code>, <code>ssh-to-age</code>)<li>installs <code>kustomize-sops</code> and places the go modules in a plugin directory, exported as <code>KUSTOMIZE_PLUGIN_HOME</code><li>exports <code>SOPS_AGE_KEY</code> based on the current user's ssh key</ul><p>This can all be configured manually on any linux distribution with the right packages, but checking in the declarative shell definition with my manifests makes my life so much simpler.<h3 id=patching-ksops>Patching ksops<a aria-label="Anchor link for: patching-ksops" class=zola-anchor href=#patching-ksops style=visibility:hidden>#</a></h3><p>When I first started working on this post, the <code>kustomizes-sops</code> package in nixpkgs was broken. The go module was renamed in v3, and there was a <a rel="nofollow noreferrer" href=https://github.com/NixOS/nixpkgs/pull/175539>2 year old PR</a> to address it (also by <code>starcraft66</code>, you rock). At the time, I created a nix derivation for <code>kustomize-sops</code> inside my repo and included it in my <code>shell.nix</code>:<pre class="language-nix z-code" data-lang=nix><code class=language-nix data-lang=nix><span class="z-source z-nix"><span class="z-variable z-parameter z-function z-4 z-nix">final</span><span class="z-punctuation z-definition z-function z-nix">:</span> <span class="z-variable z-parameter z-function z-4 z-nix">prev</span><span class="z-punctuation z-definition z-function z-nix">:</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
  <span class="z-entity z-other z-attribute-name z-multipart z-nix">kustomize-sops</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">prev</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">kustomize-sops</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">overrideAttrs</span><span class="z-punctuation z-definition z-expression z-nix">(</span><span class="z-variable z-parameter z-function z-4 z-nix">previousAttrs</span><span class="z-punctuation z-definition z-function z-nix">:</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>

    <span class="z-comment z-line z-number-sign z-nix"># Based on unresolved patch here from 2022: https://github.com/NixOS/nixpkgs/pull/175539/files</span>
    <span class="z-comment z-line z-number-sign z-nix"># module name is expected as ksops/ksops, not ksops-exec/ksops-exec after version 2</span>
    <span class="z-entity z-other z-attribute-name z-multipart z-nix">installPhase</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-expression z-nix">(</span><span class="z-variable z-parameter z-name z-nix">previousAttrs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">installPhase</span> <span class="z-keyword z-operator z-nix">or</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-definition z-expression z-nix">)</span> <span class="z-keyword z-operator z-nix">+</span> <span class="z-string z-quoted z-other z-nix"><span class="z-punctuation z-definition z-string z-other z-start z-nix">''</span>
      mkdir -p $out/lib/viaduct.ai/v1/ksops/
      cp $out/lib/viaduct.ai/v1/ksops-exec/ksops-exec $out/lib/viaduct.ai/v1/ksops/ksops
    <span class="z-punctuation z-definition z-string z-other z-end z-nix">''</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-definition z-expression z-nix">)</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
<span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></code></pre><pre class="language-diff z-code" data-lang=diff><code class=language-diff data-lang=diff><span class="z-source z-diff"><span class="z-markup z-deleted z-diff"><span class="z-punctuation z-definition z-deleted z-diff">-</span> { pkgs ? import &LTnixpkgs> {} }:
</span><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span> { pkgs ? import &LTnixpkgs> { overlays = [ (import ./.nix/overlays/kustomize-sops.nix) ]; } }:
</span></span></code></pre><h2 id=generating-age-keys>Generating Age Keys<a aria-label="Anchor link for: generating-age-keys" class=zola-anchor href=#generating-age-keys style=visibility:hidden>#</a></h2><p>(The keys in this post were only ever used for demonstration purposes. If you want to YOLO, go ahead and use it at your own risk.)<p>Generating an age key is as simple as running <code>age-keygen</code> with the optional <code>-o output.txt</code> parameter. This will generate a public/private age keypair that we can use with sops:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">michael@laptop</span></span><span class="z-meta z-function-call z-arguments z-shell"> ❯ age-keygen </span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> created: 2025-11-12T15:11:27-08:00</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> public key: age1jg5r9uynw5xp52lyac7nh0e8puxs74yqskh5fx6txd34fnkpkv8qlzzq0w</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">AGE-SECRET-KEY-1NCQSKFRE0F0T69W2PVVQZVT3C0VJMS0JQW3YFUH6KQZNE60LUSPQQR37M7</span></span>
</span></code></pre><p>We can also use <code>ssh-to-age</code> to generate public and private age keys based on an ed25519 ssh key. I'll generate a new ssh key pair and then use it to generate an age key pair here:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">michael@laptop</span></span><span class="z-meta z-function-call z-arguments z-shell"> ❯ ssh-keygen </span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Generating</span></span><span class="z-meta z-function-call z-arguments z-shell"> public/private ed25519 key pair.</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Enter</span></span><span class="z-meta z-function-call z-arguments z-shell"> file in which to save the key (/home/michael/.ssh/id_ed25519</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-colon z-shell">:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./age-example-25519</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Enter</span></span><span class="z-meta z-function-call z-arguments z-shell"> passphrase for <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>./age-example-25519<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> (empty for no passphrase</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-colon z-shell">:</span></span><span class="z-meta z-function-call z-arguments z-shell"> </span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Enter</span></span><span class="z-meta z-function-call z-arguments z-shell"> same passphrase again: </span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Your</span></span><span class="z-meta z-function-call z-arguments z-shell"> identification has been saved in ./age-example-25519</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Your</span></span><span class="z-meta z-function-call z-arguments z-shell"> public key has been saved in ./age-example-25519.pub</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">The</span></span><span class="z-meta z-function-call z-arguments z-shell"> key fingerprint is:</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SHA256:UG+fcTl6Zyh1xzV7Ha/YeAyPByzvd0RVyYaqLGfipLA</span></span><span class="z-meta z-function-call z-arguments z-shell"> michael@laptop</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">The</span></span><span class="z-meta z-function-call z-arguments z-shell"> key<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>s randomart image is:
+--[ED25519 256]--+
|        .     oo*|
|       . . . . *O|
|      .   + * *.O|
|       . . = / *o|
|        S . X X +|
|   .   + = . = + |
|    o + =   . . .|
|   E . .     . . |
|                 |
+----[SHA256]-----+

michael@laptop ❯ ssh-to-age -i age-example-25519.pub 
age1qejhjaqlwncvkhylgjnzssujjxk4mfztz8jxcdmu3frrs3vjte5s2uk8uu

michael@laptop ❯ ssh-to-age -private-key -i age-example-25519
AGE-SECRET-KEY-1QP9RZ37D6ASRU448CQ8TJNPYYE0HCQK7FA4R6LCG5RSJV28KZ7YQ3XYC5M
</span></span></span></code></pre><h2 id=configuring-sops>Configuring Sops<a aria-label="Anchor link for: configuring-sops" class=zola-anchor href=#configuring-sops style=visibility:hidden>#</a></h2><p>Now that we have some keys to work with, we can start looking at sops itself. I'll be reusing the keys generated in the previous section here.<p>Before we can encrypt anything, sops has to be told <em>what</em> should be considered secret and <em>how</em> to encrypt it. Sops automatically searches for its config file (<code>.sops.yaml</code>) in the current directory tree. Instead of rambling about how the configuration works, let's take a look at an example config file.<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">keys</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-meta z-property z-yaml"><span class="z-keyword z-control z-property z-anchor z-yaml"><span class="z-punctuation z-definition z-anchor z-yaml">&</span></span><span class="z-entity z-name z-other z-anchor z-yaml">argocd</span></span> <span class="z-string z-unquoted z-plain z-out z-yaml">age1jg5r9uynw5xp52lyac7nh0e8puxs74yqskh5fx6txd34fnkpkv8qlzzq0w</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-meta z-property z-yaml"><span class="z-keyword z-control z-property z-anchor z-yaml"><span class="z-punctuation z-definition z-anchor z-yaml">&</span></span><span class="z-entity z-name z-other z-anchor z-yaml">admin</span></span> <span class="z-string z-unquoted z-plain z-out z-yaml">age1qejhjaqlwncvkhylgjnzssujjxk4mfztz8jxcdmu3frrs3vjte5s2uk8uu</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">creation_rules</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">unencrypted_regex</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>^(apiVersion|metadata|kind|type)$<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">path_regex</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">.*\.(yaml|json|env|ini)$</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key_groups</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">age</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
          <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-keyword z-control z-flow z-alias z-yaml"><span class="z-punctuation z-definition z-alias z-yaml">*</span></span><span class="z-variable z-other z-alias z-yaml">admin</span>
          <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-keyword z-control z-flow z-alias z-yaml"><span class="z-punctuation z-definition z-alias z-yaml">*</span></span><span class="z-variable z-other z-alias z-yaml">argocd</span>
</span></code></pre><p>This basic sops config does two things:<ul><li>defines two age public keys as sops identities, named <code>admin</code> and <code>argocd</code> <ul><li><code>argocd</code>'s key is the plain age key generated earlier<li><code>admin</code>'s key is the key derived from an ssh key generated earlier</ul><li>for any file named <code>secret*</code> with the extensions <code>.yaml</code>, <code>.json</code>, <code>.env</code>, or <code>.ini</code> in the directory <code>manifests/</code>, apply the following rules: <ul><li>encrypt the values of each key in the file such that either the <code>admin</code> or <code>argocd</code> private key can decrypt them<li>do not encrypt the keys <code>apiVersion</code>, <code>metadata</code>, <code>kind</code>, or <code>type</code> if they're present in the document</ul></ul><p>Sops's config can go much deeper than this, but that's outside the scope of this post. For now, this is enough to highlight how to encrypt and decrypt secrets for use with Kubernetes. The official documentation for <code>.sops.yaml</code> is <a href="https://github.com/getsops/sops?tab=readme-ov-file#using-sops-yaml-conf-to-select-kms-pgp-and-age-for-new-files" rel="nofollow noreferrer">here</a>.<h2 id=encrypting-a-kubernetes-secret>Encrypting a Kubernetes Secret<a aria-label="Anchor link for: encrypting-a-kubernetes-secret" class=zola-anchor href=#encrypting-a-kubernetes-secret style=visibility:hidden>#</a></h2><p>With our sops config defined, we can create a secret manifest for Kubernetes and encrypt it! Let's create a basic secret, and encrypt it with sops:<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">apiVersion</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">v1</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">kind</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">Secret</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">metadata</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">my-secret</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">type</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">Opaque</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">stringData</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">SECRET_PASSWORD</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">hunter2</span>
</span></code></pre><p>This is a perfectly valid Kubernetes secret resource, but obviously we wouldn't want to commit this to git in its current state (even though there's no way you could see my password in that yaml file, right?!).<p>I've saved the secret in the same directory as <code>.sops.yaml</code>, and when I run <code>sops --encrypt</code>, it spits out a yaml file with the contents of <code>stringData</code> encrypted! (I could also use <code>--in-place</code> to overwrite the file instead of directing it to stdout, which is what I would normally do working in my repo).<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">15:56</span></span><span class="z-meta z-function-call z-arguments z-shell"> michael@laptop ❯ sops<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>encrypt</span> test-secret.yaml</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">apiVersion:</span></span><span class="z-meta z-function-call z-arguments z-shell"> v1</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kind:</span></span><span class="z-meta z-function-call z-arguments z-shell"> Secret</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">metadata:</span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">name:</span></span><span class="z-meta z-function-call z-arguments z-shell"> my-secret</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">type:</span></span><span class="z-meta z-function-call z-arguments z-shell"> Opaque</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">stringData:</span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SECRET_PASSWORD:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ENC<span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>AES256_GCM,data:Qt1RcJPgZA==,iv:Y2x8JcSk7CmghR/6V8dhKykt46pNYwZjoY8srdiWGdA=,tag:1L9s418X6E39RR/IbNsueg==,type:str<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sops:</span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">age:</span></span>
        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> recipient: age1qejhjaqlwncvkhylgjnzssujjxk4mfztz8jxcdmu3frrs3vjte5s2uk8uu</span>
          <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">enc:</span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-----BEGIN</span></span><span class="z-meta z-function-call z-arguments z-shell"> AGE ENCRYPTED FILE-----</span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBQNFMzdHhkbmVBTTBJL1Fl</span></span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SkpVN1ZPQ1pEU2lOWk9ZV2twREFXQ0p2bUdBCm9hdzRabUZtdzcreGdjZnl2WjFY</span></span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ZEtuZmk4aUtscGJObk0rRmFhaUFMbGMKLS0tIHZ4ZkhFVWlMS2N1cVg5dU1WWmc5</span></span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">YnYyRUxjZEd1ZGowOEViWjNKY0tEMnMK1kIkFSGyliVBX9R4G+WKDBhAiw7VXD9b</span></span>
            <span class="z-variable z-other z-readwrite z-assignment z-shell">CHm2mmskmgaBNOlNFhll/CsYwEvxPb3ehf1dxj6QP335ShmRK2qo0A</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">=</span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-----END</span></span><span class="z-meta z-function-call z-arguments z-shell"> AGE ENCRYPTED FILE-----</span>
        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> recipient: age1jg5r9uynw5xp52lyac7nh0e8puxs74yqskh5fx6txd34fnkpkv8qlzzq0w</span>
          <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">enc:</span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-----BEGIN</span></span><span class="z-meta z-function-call z-arguments z-shell"> AGE ENCRYPTED FILE-----</span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBDZ1BTQjh1Wm5ZalZ3T2hL</span></span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">N1NqamNVeTcrTnZTY01yekREYmJGRDdwR2dvCmFXQXhVNUJUQlRzcThuYmpUTDh0</span></span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SlNRdnpQTGFQbkFZdHJpNEU3aGVCZmsKLS0tIEUwelRwLzJQaVFNVGFBMXRvWVAw</span></span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">aVNXQ1RjVjlINm9vY1JWN0g3bmVNeDQKY1aFNPgq2z6kYZ/47TCzB6o6cQUFJ1eq</span></span>
            <span class="z-variable z-other z-readwrite z-assignment z-shell">kfS9Bsi0bRA2/xD4W0ChuNgvwmBOLwZcSSJYvnZxp82OZBzoJPbpYQ</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">=</span>
            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-----END</span></span><span class="z-meta z-function-call z-arguments z-shell"> AGE ENCRYPTED FILE-----</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">lastmodified:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>2025-11-12T23:56:33Z<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mac:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ENC<span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>AES256_GCM,data:zLLitqbHNqKY/j2cdYgule6R80FBxwJsu8/WYuCcX3MDtf+2z8KJUzCIXu56zpL7xRc6I6Hrd0PlIvuj1YRo1Hu9/8fJ+B0ulDyOnZ1fypBh5rGCbrywZgZSKsWSByEAtL1Fz6MHF5xX2bVeUJ1kabzLmF/S3LT5ISvx22HlmYA=,iv:pMpu3g96eqzGEzXVHYZJ953T4UBXJyJ+n03jD0UCa+8=,tag:3+EpPzJ64LTEErnWobe2mw==,type:str<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">unencrypted_regex:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ^(apiVersion</span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">metadata</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kind</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">type</span></span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">version:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 3.11.0</span>
</span></code></pre><p>But wait! there are two blocks containing <code>BEGIN AGE ENCRYPTED FILE</code>, but we only have one piece of encrypted data!<p>Because both identities are listed in the same key group in <code>.sops.yaml</code>, either key on it's own can decrypt the value. If multiple key groups are present, <em>at least one key from each group</em> must be present to decrypt the data.<h1 id=deploying-encrypted-secrets-with-argocd>Deploying Encrypted Secrets with ArgoCD<a aria-label="Anchor link for: deploying-encrypted-secrets-with-argocd" class=zola-anchor href=#deploying-encrypted-secrets-with-argocd style=visibility:hidden>#</a></h1><h2 id=telling-kustomize-about-our-secrets>Telling Kustomize about our Secrets<a aria-label="Anchor link for: telling-kustomize-about-our-secrets" class=zola-anchor href=#telling-kustomize-about-our-secrets style=visibility:hidden>#</a></h2><p>Encrypting our secrets is one thing, but deploying them is another. Sops encryption protects the secrets at rest in git but they must be decrypted before they're applied to a Kubernetes cluster. I mentioned <a href=https://mikansoro.org/blog/sealed-secrets-to-sops/#kubernetes-with-ksops>ksops</a> above; it's a kustomize plugin that handles on-the-fly decryption of sops-encrypted files when running commands like <code>kustomize build</code>. Since ArgoCD understands kustomize, ksops can handle decryption both on my local machine and in ArgoCD.<p>Let's take this typical <code>kustomization.yaml</code> file as an example, and add an encrypted secret to it.<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">apiVersion</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">kustomize.config.k8s.io/v1beta1</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">kind</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">Kustomization</span>

<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">resources</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">resources/cluster-issuer.yaml</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">resources/wildcard-cert.yaml</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">resources/cluster-wildcard-cert.yaml</span>
</span></code></pre><p>This applies two Certificates and one ClusterIssuer cert-manager resource to create two wildcard TLS certificates for my ingress to use. The ClusterIssuer needs an API key for a supported DNS service like Cloudflare or Digital Ocean to create proof of ownership DNS records for the domain. Let's pretend our <code>test-secret.yaml</code> holds the API key for Cloudflare, and is currently in <code>secrets/test-secret.yaml</code>. If it was added to the <code>resources:</code> block directly in kustomization.yaml, Kubernetes wouldn't understand what to do with it. To tell ksops to decrypt it, we add a secret generator:<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> secret-generator.yaml
</span><span class="z-entity z-other z-document z-begin z-yaml">---</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">apiVersion</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">viaduct.ai/v1</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">kind</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">ksops</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">metadata</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">secret-generator</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">files</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">secrets/test-secret.yaml</span>
</span></code></pre><pre class="language-diff z-code" data-lang=diff><code class=language-diff data-lang=diff><span class="z-source z-diff">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

<span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>generators:
</span><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>  - secret-generator.yaml
</span>
resources:
  - resources/cluster-issuer.yaml
  - resources/wildcard-cert.yaml
  - resources/cluster-wildcard-cert.yaml
</span></code></pre><p>With the plugin installed, running <code>kustomize build</code> will decrypt the secret and add it to the output.<h2 id=i-thought-this-was-about-argocd>I thought this was about ArgoCD...<a aria-label="Anchor link for: i-thought-this-was-about-argocd" class=zola-anchor href=#i-thought-this-was-about-argocd style=visibility:hidden>#</a></h2><p>Now that Kustomize can read and decrypt the secrets, it's time to give ArgoCD the same power. The steps remaining are as follows:<ol><li>Generate an age key for argocd, different from our other keys<li>Add the key to <code>.sops.yaml</code><li>Run <code>sops updatekeys $file</code> for each file, or to run against every sops file:</ol><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">GIT_BASE</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> rev-parse<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>show-toplevel</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span>
<span class="z-keyword z-control z-loop z-for z-shell">for</span><span class="z-meta z-group z-for z-shell"> file <span class="z-keyword z-control z-in z-shell">in</span> <span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>lrE</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>sops[<span class="z-constant z-character z-escape z-shell">\"</span>]?[:|_age]<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">GIT_BASE</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-loop z-do z-shell">do</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sops</span></span><span class="z-meta z-function-call z-arguments z-shell"> updatekeys <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">file</span></span></span> <span class="z-keyword z-operator z-logical z-or z-shell">||</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">true</span></span>
<span class="z-keyword z-control z-loop z-end z-shell">done</span>
</span></code></pre><ol start=4><li>Add the key as a secret to ArgoCD's namespace (you can encrypt it with sops and keep it in the repo, but you must <code>kubectl apply -n argocd -f</code> the secret from a decrypted state the first time)<li>Add the ksops plugin to argocd</ol><p>The first four steps are pretty self-explanatory and have already been covered above, so those will remain an exercise to the reader.<p>Instead of rebuilding an argocd image (a valid way to handle this), we'll use an initContainer to install the binary in a volume, and mount that volume into the <code>argocd-repo-server</code> pod. Let's create a Kustomize patch to add ksops support to the argocd repo server, mount our Kubernetes age key secret as a volume, and add the <code>SOPS_AGE_KEY_FILE</code> environment variable.<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> argocd/patches/argocd-repo-server-ksops.yaml
</span><span class="z-entity z-other z-document z-begin z-yaml">---</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">apiVersion</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">apps/v1</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">kind</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">Deployment</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">metadata</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">argocd-repo-server</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">spec</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">template</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">spec</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
      <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> 1. Define an emptyDir volume which will hold the custom binaries
</span>      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">volumes</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">kustomize-plugins</span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">emptyDir</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-mapping z-yaml"><span class="z-punctuation z-definition z-mapping z-begin z-yaml">{</span><span class="z-punctuation z-definition z-mapping z-end z-yaml">}</span></span>
        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">sops-age</span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secret</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
            <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretName</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">sops-age</span>
      <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> 2. Use an init container to download/copy custom binaries into the emptyDir
</span>      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">initContainers</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">install-ksops</span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">image</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">viaductoss/ksops:v4.3.2</span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">command</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>/bin/sh<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span><span class="z-punctuation z-separator z-sequence z-yaml">,</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>-c<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">args</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
            <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">echo "Installing KSOPS...";</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml">mkdir -p /kustomize-plugins/viaduct.ai/v1/ksops/;</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml">mv ksops /kustomize-plugins/viaduct.ai/v1/ksops/ksops;</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml">echo "Done.";</span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">volumeMounts</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
            <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">mountPath</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/kustomize-plugins</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">kustomize-plugins</span>
      <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> 3. Volume mount the custom binary to the bin directory (overriding the existing version)
</span>      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">containers</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">argocd-repo-server</span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">env</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
            <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">SOPS_AGE_KEY_FILE</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">value</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/secret/age.key</span>
            <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">KUSTOMIZE_PLUGIN_HOME</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">value</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/kustomize-plugins</span>
          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">volumeMounts</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
            <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">mountPath</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/kustomize-plugins</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">kustomize-plugins</span>
              <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span>subPath: ksops
</span>            <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">sops-age</span>
              <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">mountPath</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/secret</span>
</span></code></pre><p>To add a file patch (which does a strategicMerge), add it like so:<pre class="language-diff z-code" data-lang=diff><code class=language-diff data-lang=diff><span class="z-source z-diff"># argocd/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd
generators:
  - secret-generator.yaml
resources:
  - ./custom
  - ./external
<span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>patches:
</span><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>  - path: patches/argocd-repo-server-ksops.yaml
</span>
</span></code></pre><p>With a final <code>kustomize build argocd | kubectl apply -f -</code>, ArgoCD can now read sops-encrypted secrets and deploy them like any other resource.</article></div><footer><div class=copyright><p>© 2023 mikansoro</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>